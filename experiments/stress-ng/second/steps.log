###########  KV Drive  ##########
# stress-ng, version 0.06.06 
make CC=gcc LDFLAGS=-lrt; make install

#####  kv3  #####
# postprocess.py and stress-ng.sh should be in the same directory
#   - stress-ng.sh -> entrypoint.sh
#   - postprocess.py -> postprocess.py
# Modified from https://github.com/ljishen/docker-bench/tree/master/stress-ng
wget https://github.com/ljishen/srl/raw/master/kivier/experiments/stress-ng/second/postprocess.py
wget https://github.com/ljishen/srl/raw/master/kivier/experiments/stress-ng/second/stress-ng.sh

# Since stress-ng.sh will execute postprocess.py on 192.168.140.81
ssh-copy-id issdm@192.168.140.81

root@kv3:~/stress-ng-results#../stress-ng.sh > without_kv3_1.json
root@kv3:~/stress-ng-results#../stress-ng.sh > without_kv3_2.json
root@kv3:~/stress-ng-results#../stress-ng.sh > without_kv3_3.json
root@kv3:~/stress-ng-results#../stress-ng.sh > without_kv3_4.json


#####  kv1  #####
# Do the similar steps as on kv3


###########  issdm-6  ###########
docker run --rm -ti --cpuset-cpus=1 ljishen/stress-ng > without_issdm-6_1.json
docker run --rm -ti --cpuset-cpus=1 ljishen/stress-ng > without_issdm-6_2.json
docker run --rm -ti --cpuset-cpus=1 ljishen/stress-ng > without_issdm-6_3.json


###########  rackform1  ###########
docker run --rm --cpuset-cpus=1 ljishen/stress-ng > without_rackform1_1.json
docker run --rm --cpuset-cpus=1 ljishen/stress-ng > without_rackform1_2.json
docker run --rm --cpuset-cpus=1 ljishen/stress-ng > without_rackform1_3.json


###########  Choose stressors for calibration  ##########
# Move all produced data to srl/kivier/experiments/stress-ng/second/all_data
# Hard link one result file from each machine to srl/kivier/experiments/stress-ng/second/proc_data
ln -f all_data/without_issdm-6_3.json proc_data/without_issdm-6_3.json
ln -f all_data/without_rackform1_3.json proc_data/without_rackform1_3.json
ln -f all_data/without_kv3_4.json proc_data/without_kv3_4.json
ln -f all_data/without_kv1_4.json proc_data/without_kv1_4.json

# Create merged results to srl/kivier/experiments/stress-ng/second/results/alltests.csv
srl/kivier/experiments/stress-ng/second/merge_results

# Run scipy jupyter notebook to run normalize.py and orderByNorm.py (need pandas library)
root@piha:/home/ljishen/srl/kivier/experiments/stress-ng/second# docker run --rm -ti -p 8880:8888 -v `pwd`:/home/jovyan/work:rw --user root --entrypoint=/bin/bash jupyter/scipy-notebook

# Use results from kv3 as base to normalize, then output normalized results to
# srl/kivier/experiments/stress-ng/second/results/alltests_with_normalized_results.csv
./normalize.py kv3

# Only retain `machine=issdm-6` from srl/kivier/experiments/stress-ng/second/results/alltests_with_normalized_results.csv 
# and order rows by values from column `normalizedo`, then output ordered results to
# srl/kivier/experiments/stress-ng/second/results/alltests_with_normalized_ordered_results.csv
./orderByNorm.py issdm-6

# At this point, srl/kivier/experiments/stress-ng/second/results/alltests_with_normalized_ordered_results.csv contains normalized values (issdm-6/kv3) order by desc.
# We choose two stressors from the list in file `alltests_with_normalized_ordered_results.csv`, and create `base_without_kv3_4.json` by manually adding
# ```
#  "id": "stress-ng",
#  "docker_flags": "--rm --cpuset-cpus=1",
#  "image_name": "ljishen/stress-ng",
#  "image_args": "",
# ```
# to the head of this file and wrap all test results for calibration in a tests array.
# Example: https://github.com/ivotron/torpor-popper/blob/master/ansible/tune-targets/base.json


###########  Run torpor on issdm-6  ###########
git clone https://github.com/ljishen/torpor.git

# File base_without_kv3_4.json is in current working directory.
torpor/torpor --categories=cpu --show-bench-results --max-cpu-quota=10000 --test-limit 15 --base-filename base_without_kv3_4.json

# - First time, we choose stressor `stressng-cpu-sqrt` and `stressng-cpu-cpu`, the results moved to 
# srl/kivier/experiments/stress-ng/second/results/calibration_results/issdm-6/1/
#
#- Second time, we only choose `stressng-cpu-cpu`, the results moved to
# srl/kivier/experiments/stress-ng/second/results/calibration_results/issdm-6/2/
