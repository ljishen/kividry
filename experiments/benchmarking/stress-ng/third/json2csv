#!/bin/bash -e

if [ "$#" -ne 1 ]; then
    echo "Please specify a json file as argument."
    echo "Usage: ./json2csv <json file>"
    exit 0
fi

filename=results/alltests.csv
mkdir -p $(dirname $filename)

header="machine,limits,benchmark,class,lower_is_better,repetition,result"
if [ ! -f "$filename" ] || ! grep -q "$header" "$filename"; then
    echo "$header" > $filename
fi

bn=`basename "$1" .json`
machine=`echo "$bn" | cut -d _ -f 2`
method=`echo "$bn" | cut -d _ -f 1`
repetition=`echo "$bn" | cut -d _ -f 3`

jq -r --arg m $method --arg n $machine --arg r $repetition '.[] | [$n,  $m, .name, .class, .lower_is_better, $r, .result] | @csv' $1 >> $filename
